<?php

/**
 * @file
 * Main finctions for booking calendar.
 */


/**
 * Implements hook_init().
 */
function booking_calendar_init() {
  drupal_add_css(drupal_get_path('module', 'booking_calendar') . '/css/global.css', array(
    'group' => CSS_DEFAULT,
    'type' => 'file'
  ));
  drupal_add_js(drupal_get_path('module', 'booking_calendar') . '/js/widget.js');

}

/**
 * Implements hook_menu().
 */
function booking_calendar_menu() {
  $items['admin/config/content/booking_calendar'] = array(
    'page callback' => 'booking_calendar_admin_settings',
    'access arguments' => array('administer booking calendar'),
    'type' => MENU_CALLBACK,
  );


  $items['booking/calendar/ajax'] = array(
    'page callback' => 'booking_calendar_month_ajax',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );


  $items['booking/calendar/widget/calendar/select/ajax'] = array(
    'page callback' => 'booking_calendar_widget_calendar_select_ajax',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['booking/calendar/widget/calendar/table/book/ajax'] = array(
    'page callback' => 'booking_calendar_widget_table_book_ajax',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );


  return $items;
}

/**
 * Implements hook_permission().
 */
function booking_calendar_permission() {
  return array(
    'administer booking calendar' => array(
      'title' => t('Administer the Booking Calendar'),
      'description' => t('Allow users use Booking Calendar'),
    ),
  );
}


/**
 * Implements hook_theme().
 */
function booking_calendar_theme($existing, $type, $theme, $path) {
  return array(
    'booking_calendar_admin' => array(
      'variables' => array(
        'week' => NULL,
        'month' => NULL,
        'year' => NULL,
        'widget' => FALSE,
      ),
    ),
    'booking_calendar_admin_table_day_hours' => array(
      'variables' => array(
        'year' => NULL,
        'month' => NULL,
        'day' => NULL,
        'widget' => FALSE,
        'ajax' => FALSE,
      ),
    ),
    'booking_calendar_widget_select_day_hours' => array(
      'variables' => array(
        'year' => NULL,
        'month' => NULL,
        'day' => NULL,
      ),
    ),
    'booking_calendar_cart_pre_output' => array(
      'variables' => array(),
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function booking_calendar_block_info() {
  $blocks = array();

  $blocks['booking_calendar_widget'] = array(
    'info' => t('Booking calendar widget'),
    'cache' => DRUPAL_CACHE_PER_ROLE,
  );
  $blocks['booking_calendar_table_widget'] = array(
    'info' => t('Booking calendar table widget'),
    'cache' => DRUPAL_CACHE_PER_ROLE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function booking_calendar_block_view($delta = '') {
  // The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'booking_calendar_widget':
      $block['subject'] = t('');
      $block['content'] = booking_calendar_block_contents($delta);
      break;
    case 'booking_calendar_table_widget':
      $block['subject'] = t('');
      $block['content'] = booking_calendar_block_contents($delta);
      break;
  }
  return $block;
}


/**
 * A module-defined block content function.
 */
function booking_calendar_block_contents($which_block) {

  switch ($which_block) {
    case 'booking_calendar_widget':
      $cart_pre_output = theme_booking_calendar_cart_pre_output();
      $result = array(
        '#markup' => '<div id="t3"></div>' . theme('booking_calendar_admin', array(
            'week' => _booking_calendar_calculate(),
            'widget' => TRUE
          ))
          . $cart_pre_output
      );
      break;

    case 'booking_calendar_table_widget':
      $year = date('Y');
      $month = date('n');
      $day = date('j');

      $result = array(
        '#markup' => theme('booking_calendar_widget_select_day_hours', array(
          'year' => $year,
          'month' => $month,
          'day' => $day,
        ))
      );
      break;

  }
  return $result;
}


/**
 * Defines form callback for the admin/config/availability-calendar/settings
 * page.
 */
function booking_calendar_admin_settings() {
  drupal_add_js(drupal_get_path('module', 'booking_calendar') . '/js/calendar.js');
  drupal_add_css(drupal_get_path('module', 'booking_calendar') . '/css/calendar.css');

  $output = '';
  $output .= '<div id="t3"></div>';
  $output .= '<div class="flags">
                <ul>
                    <li class="this"><span class="av">' . t('Pasiekiamas') . '</span></li>
                    <li><span class="na">' . t('Pilnai nubaustas') . '</span></li>
                    <li><span class="opt">' . t('Pašalinti nubaustas') . '</span></li>
                </ul>
            </div>';

  $output .= '<div id="calendar-wrapper">';
  $output .= theme('booking_calendar_admin', array('week' => _booking_calendar_calculate()));
  $output .= '</div>';

  /*********** Begin Hours table ********/

  $output .= '<div id="hours-table-wrapper">';

  if (!empty($_SESSION['current_select'])) {

    // Select curren state table!
    $current_state = $_SESSION['current_select'];
    $year = $current_state['year'];
    $month = $current_state['month'];
    $day = $current_state['day'];

    $output .= theme('booking_calendar_admin_table_day_hours', array(
      'year' => $year,
      'month' => $month,
      'day' => $day,
    ));
  }
  else {
    $output .= theme('booking_calendar_admin_table_day_hours');
  }

  $output .= '</div>';


  /*********** END HOURS TABLE **********/

  return $output;
}


/**
 * @file
 */


/**********************************WIDGET AJAX*******************************/

/**
 * Ajax callback for select calendar widget.
 */
function booking_calendar_widget_calendar_select_ajax() {
  if (count($_POST)) {
    isset($_POST['day']) ? $day = $_POST['day'] : $day = date('j');
    isset($_POST['month_number']) ? $month = $_POST['month_number'] : $month = date('n');
    isset($_POST['year']) ? $year = $_POST['year'] : $year = date('Y');
    $hours_table = theme('booking_calendar_admin_table_day_hours', array(
      'year' => $year,
      'month' => $month,
      'day' => $day,
      'widget' => TRUE,
      'ajax' => TRUE,
    ));
    $response = array(
      'hours_table' => $hours_table,
    );
    return drupal_json_output($response);
  }
  return drupal_not_found();
}


/**
 * @param $variables
 * @return string
 */
function theme_booking_calendar_widget_select_day_hours($variables) {


  $hours = array();
  $minutes = 0;
  $interval = 30;

  $year = $variables['year'];
  $month = $variables['month'];
  $day = $variables['day'];

  if (empty($_SESSION['hours_settings'])) {
    $hours_settings = variable_get('booking_hours_settings', '');
  }
  else {
    $hours_settings = $_SESSION['hours_settings'];
  }


  if (empty($hours_settings)) {
    $hour_end = 22;
    $hour_begin = 8;
  }
  else {
    if (isset($hours_settings[$year]) && isset($hours_settings[$year][$month]) && isset($hours_settings[$year][$month][$day])) {
      $hour_end = $hours_settings[$year][$month][$day]['hour_end'];
      $hour_begin = $hours_settings[$year][$month][$day]['hour_begin'];

      $year = $variables['year'];
      $month = $variables['month'];
      $day = $variables['day'];
      $hour_end = $hours_settings[$year][$month][$day]['hour_end'];
      $hour_begin = $hours_settings[$year][$month][$day]['hour_begin'];
    }
    else {
      $hour_end = 22;
      $hour_begin = 8;
    }
  }


  /****************************** MAIN LOGIC **********************************/

  //count = (($hour_end - $hound_begin)*interval for hours)+2;
  $count = (($hour_end - $hour_begin) * 2) + 2;
  /********* CREATE HOURS ARRAY **********/
  for ($i = 0; $i < $count; $i++) {
    $hours[$i] = date('H : i', mktime($hour_begin, $minutes, 0, date('n'), date('j'), date('Y')));
    $minutes += $interval;
  }

  /*********** CREATE COURTS SETTINGS ARRAY - NAME - PRICE etc ************/
  if (!empty(variable_get('booking_calendar_names_courts', ''))) {
    $courts = variable_get('booking_calendar_names_courts', '');
    if (!empty($_SESSION['table_hours'])) {
      if (isset($_SESSION['table_hours'][$year]) && isset($_SESSION['table_hours'][$year][$month]) && isset($_SESSION['table_hours'][$year][$month][$day])) {
        $courts = $_SESSION['table_hours'][$year][$month][$day];
      }
    }
  }
  else {
    $courts = _default_hours_and_name_courts();
  }

  //Add fist column - time.
  array_unshift($courts, array('name' => t('TIME - ') . $year . '-' . $month . '-' . $day));


  /********************** END MAIN LOGIC ********************/


  /************************* CREATE HTML OUTPUT ************/

  $output = '';
  $classes = ' ';
  $output .= '<div id="t4" style="display: none;"></div><div id="booking-courts-wrapper"><table id="booking-courts"><thead><tr>';
  $k = 1;
  foreach ($courts as $court) {
    if ($k == 1) {
      $classes .= 'first';
    }
    else {
      $classes = '';
    }


    if (!empty($court['name'])) {
      $output .= '<td class="' . $classes . '">' . $court['name'] . '</td>';
    }
    else {
      $output .= '<td></td>';
    }
    $k++;
  }
  $output .= '</tr></thead>';

  foreach ($hours as $hour) {
    $output .= '<tr>';
    $a = 0;
    foreach ($courts as $court) {
      if ($a == 0) {
        $output .= '<td>' . $hour . '</td>';
      }
      else {
        if ($court['name']) {
          $hour_key = str_replace(' : ', '_', $hour);
          if (!empty(variable_get('booking_calendar_names_courts', ''))) {
            if (isset($court['hours'][$hour]['price'])) {
              if (array_key_exists($court['name'], $_SESSION['client_hours'][$year][$month][$day]) && array_key_exists($hour, $_SESSION['client_hours'][$year][$month][$day][$court['name']])) {

                $output .= '<td class="value selected-user" year="' . $year . '" month="' . $month . '" day="' . $day . '" hour="' . $hour . '" name="' . $court['name'] . ' ">' . $court['hours'][$hour]['price'] . '€' . '</td>';


              }
              else {
                $output .= '<td class="value " year="' . $year . '" month="' . $month . '" day="' . $day . '" hour="' . $hour . '" name="' . $court['name'] . ' ">' . $court['hours'][$hour]['price'] . '€' . '</td>';
              }
            }
            else {
              $output .= '<td class="value " year="' . $year . '" month="' . $month . '" day="' . $day . '" hour="' . $hour . '" name="' . $court['name'] . ' ">' . 0 . '€' . '</td>';
            }
          }
          else {
            $output .= '<td class="value " year="' . $year . '" month="' . $month . '" day="' . $day . '" hour="' . $hour . '" name="' . $court['name'] . ' ">' . $court['hours'][$hour]['price'] . '</td>';
          }
        }
      }
      $a++;
    }
    '</tr>';
  }
  $output .= '</table></div>';

  return $output;
}

//_booking_calendar_clear_all_products();
function booking_calendar_widget_table_book_ajax() {

  $flag = $_POST['flag'];
  $table_client = (array) json_decode($_POST['table_client']);
  // Clear js values!
  $table_client = TrimArray($table_client);
  $year = $table_client['year'];
  $month = $table_client['month'];
  $day = $table_client['day'];
  $hour = $table_client['hour'];
  $court = $table_client['name'];
  $price = $table_client['price'];


  // Save click values in SESSION.
  $_SESSION['client_hours'][$year][$month][$day][$court][$hour] = $price;
  global $user;

  if ($flag == 'select') {


    $product_id = _booking_calendar_commerce_create_product($table_client);
    // Create the new order in checkout; you might also check first to
    // see if your user already has an order to use instead of a new one.`
    _booking_calendar_commerce_create_order($product_id);



  }
  elseif ($flag == 'unselect') {

    // Delete unselect value in SESSION.
    unset($_SESSION['client_hours'][$year][$month][$day][$court][$hour]);


    $orders = db_select('commerce_order', 'co')
      ->fields('co', array('order_id'))
      ->condition('co.uid', $user->uid)
      ->execute()
      ->fetchAll();
    foreach ($orders as $row_order) {
      $orders_ids[] = $row_order->order_id;
    }
    $last_order = array_pop($orders_ids);

    $count_line_items = db_select('commerce_line_item', 'clis')
      ->condition('clis.order_id', $last_order)
      ->countQuery()
      ->execute()
      ->fetchField();

    if (empty($count_line_items)) {
      commerce_order_delete($last_order);
    }

      $line_items = db_select('commerce_line_item', 'cli')
        ->fields('cli', array('line_item_id'))
        //->condition('cli.order_id', $last_order)
        ->execute()
        ->fetchAll();
      foreach ($line_items as $row_line_item) {
        $line_item_ids[] = $row_line_item->line_item_id;
      }
      commerce_line_item_delete(array_pop($line_item_ids));

    // Delete current click product!
    $query = db_query("SELECT fdfy.entity_id FROM field_data_field_year as fdfy
                        left join field_data_field_month as fdfm
                        on fdfy.entity_id = fdfm.entity_id
                        left join field_data_field_day as fdfd
                        on fdfm.entity_id = fdfd.entity_id
                        left join field_data_field_hour as fdfh
                        on fdfd.entity_id = fdfh.entity_id
                        left join field_data_field_court as fdfc
                        on fdfh.entity_id = fdfc.entity_id
                        where field_year_value = '$year' AND
                        field_month_value = '$month' AND
                        field_day_value = '$day' AND
                        field_hour_value = '$hour' AND
                        field_court_value = '$court';
                        ");
    foreach ($query as $row_query) {
      $product_id = $row_query->entity_id;
    }
    commerce_product_delete($product_id);



  }


  $cart_block = views_embed_view('commerce_cart_block', 'default');

  $response = array(
    'cart_block' => $cart_block,
  );
  return drupal_json_output($response);





}


function _booking_calendar_commerce_create_product($table) {
  global $user;
  $uid = $user->uid;

  $year = $table['year'];
  $month = $table['month'];
  $day = $table['day'];
  $court = $table['name'];
  $name = $table['name'];
  $price = $table['price'];
  $hour = $table['hour'];

  $product = commerce_product_new('product');
  $product->uid = $uid;
  $product->sku = time();
  $product->title = $name;
  $product->language = LANGUAGE_NONE;
  $product->commerce_price[LANGUAGE_NONE][0] = array(
    'amount' => $price * 100, // $10
    'currency_code' => "EUR",
  );
  $product->field_year[LANGUAGE_NONE][0]['value'] = $year;
  $product->field_month[LANGUAGE_NONE][0]['value'] = $month;
  $product->field_day[LANGUAGE_NONE][0]['value'] = $day;
  $product->field_hour[LANGUAGE_NONE][0]['value'] = $hour;
  $product->field_court[LANGUAGE_NONE][0]['value'] = $court;

  commerce_product_save($product);
  $product_id = commerce_product_load_by_sku($product->sku);
  return ($product_id->product_id);
}

function _booking_calendar_commerce_create_order($product_id) {
  global $user;


  $count_orders = db_select('commerce_order', 'cos')
    ->condition('cos.uid', $user->uid)
    ->countQuery()
    ->execute()
    ->fetchField();

  if (!empty($count_orders)) {
    // Add to old order!!!
    $orders = db_select('commerce_order', 'co')
      ->fields('co', array('order_id'))
      ->condition('co.uid', $user->uid)
      ->execute()
      ->fetchAll();
    foreach ($orders as $row) {
      $orders_ids[] = $row->order_id;
    }
    $order = commerce_order_load($orders_ids[0]);

    // Load whatever product represents the item the customer will be
    // paying for and create a line item for it.
    $product = commerce_product_load($product_id);
    $line_item = commerce_product_line_item_new($product, 1, $orders_ids[0]);
    // Save the line item to get its ID.
    commerce_line_item_save($line_item);
    // Add the line item to the order using fago's rockin' wrapper.
    $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
    $order_wrapper->commerce_line_items[] = $line_item;


    // Save the order again to update its line item reference field.
    commerce_order_save($order);
  }
  else {
    // Create the new order in checkout; you might also check first to
    // see if your user already has an order to use instead of a new one.
    $order = commerce_order_new($user->uid, 'cart');

    // Save the order to get its ID.
    commerce_order_save($order);


    // Load whatever product represents the item the customer will be
    // paying for and create a line item for it.
    $product = commerce_product_load($product_id);
    $line_item = commerce_product_line_item_new($product, 1, $order->id);
    // Save the line item to get its ID.
    commerce_line_item_save($line_item);
    // Add the line item to the order using fago's rockin' wrapper.
    $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
    $order_wrapper->commerce_line_items[] = $line_item;


    // Save the order again to update its line item reference field.
    commerce_order_save($order);
  }


}


function _booking_calendar_clear_all_products() {
  db_truncate('commerce_line_item')->execute();
  db_truncate('commerce_order')->execute();
  db_truncate('commerce_order_revision')->execute();
  db_truncate('commerce_product')->execute();
  db_truncate('commerce_product_revision')->execute();


  db_truncate('field_data_commerce_display_path')->execute();
  db_truncate('field_data_commerce_line_items')->execute();
  db_truncate('field_data_commerce_order_total')->execute();
  db_truncate('field_data_commerce_price')->execute();
  db_truncate('field_data_commerce_product')->execute();
  db_truncate('field_data_commerce_total')->execute();
  db_truncate('field_data_commerce_unit_price')->execute();


  db_truncate('field_revision_commerce_display_path')->execute();
  db_truncate('field_revision_commerce_line_items')->execute();
  db_truncate('field_revision_commerce_order_total')->execute();
  db_truncate('field_revision_commerce_price')->execute();
  db_truncate('field_revision_commerce_product')->execute();
  db_truncate('field_revision_commerce_total')->execute();
  db_truncate('field_revision_commerce_unit_price')->execute();


  db_truncate('field_data_field_court')->execute();
  db_truncate('field_data_field_day')->execute();
  db_truncate('field_data_field_hour')->execute();
  db_truncate('field_data_field_month')->execute();
  db_truncate('field_data_field_year')->execute();


  db_truncate('field_revision_field_court')->execute();
  db_truncate('field_revision_field_day')->execute();
  db_truncate('field_revision_field_hour')->execute();
  db_truncate('field_revision_field_month')->execute();
  db_truncate('field_revision_field_year')->execute();
}


/********************************** END WIDGET AJAX*******************************/


/**
 * Ajax callback.
 */
function booking_calendar_month_ajax() {

  if (count($_POST)) {
    // We calculate the number of days in the current month.
    $dayofmonth = date('t');
    // Counter for the days of the month.
    $day_count = 1;

    isset($_POST['day']) ? $day = $_POST['day'] : $day = date('j');

    isset($_POST['month_number']) ? $month = $_POST['month_number'] : $month = date('n');

    isset($_POST['year']) ? $year = $_POST['year'] : $year = date('Y');

    isset($_POST['table']) ? $table = json_decode($_POST['table']) : $table = array();

    isset($_POST['current_select']) ? $current_select = json_decode($_POST['current_select']) : $current_select = array();

    isset($_POST['widget']) ? $widget = TRUE : $widget = FALSE;

    $table = (array) $table;


    if ($widget) {
      $table_client = (array) json_decode($_POST['table_client']);
      // _booking_calendar_commerce_create_product($table_client);
    }

    $current_select = (array) $current_select;

    if (!$widget) {
      // Save values in session
      $_SESSION['tables'][$year][$month][$day] = $table;

      if (count($current_select) > 0) {
        $_SESSION['current_select'] = $current_select;
        $current_select_base = $_SESSION['current_select'];
        variable_set('current_select', $current_select_base);
      }


      $booking_tables = $_SESSION['tables'];
      // If session is expired save value in database
      variable_set('booking_calendar_book_table', $booking_tables);
    }


    // 1. The first week.
    $num = 0;
    for ($i = 0; $i < 7; $i++) {
      // Calculate the number of days of the week for the number of.
      $dayofweek = date('w', mktime(0, 0, 0, $month, $day_count, $year));

      // Leads to a number of the format 1 - Monday, ..., 6 - Saturday.
      $dayofweek = $dayofweek - 1;
      if ($dayofweek == -1) {
        $dayofweek = 6;
      }

      if ($dayofweek == $i) {
        // If the same days of the week,
        // Fill the array $week
        // Number of months.
        $week[$num][$i] = $day_count;
        $day_count++;
      }
      else {
        $week[$num][$i] = "";
      }
    }

    // 2. The following week of the month.
    while (TRUE) {
      $num++;
      for ($i = 0; $i < 7; $i++) {
        $week[$num][$i] = $day_count;
        $day_count++;
        // If you have reached the end of the month - leave
        // The loop.
        if ($day_count > $dayofmonth) {
          break;
        }
      }
      // If you have reached the end of the month - leave
      // From the cycle.
      if ($day_count > $dayofmonth) {
        break;
      }
    }

    // Save for curren click state.
    if (!empty($_SESSION['current_select'])) {

      $current_state = $_SESSION['current_select'];
      $year = $current_state['year'];
      $month = $current_state['month'];
      $day = $current_state['day'];

      $hours_table = theme('booking_calendar_admin_table_day_hours', array(
        'year' => $year,
        'month' => $month,
        'day' => $day,
      ));

      // If widget block
      if ($widget) {
        $year = $_POST['year'];
        $month = $_POST['month_number'];
        $day = $_POST['day'];

        $hours_table = theme('booking_calendar_admin_table_day_hours', array(
          'year' => $year,
          'month' => $month,
          'day' => $day,
          'widget' => $widget,
          'ajax' => TRUE,
        ));


      }

    }
    else {
      $hours_table = theme('booking_calendar_admin_table_day_hours');
      // If widget block
      if ($widget) {
        $year = $_POST['year'];
        $month = $_POST['month_number'];
        $day = $_POST['day'];

        $hours_table = theme('booking_calendar_admin_table_day_hours', array(
          'year' => $year,
          'month' => $month,
          'day' => $day,
          'widget' => $widget,
          'ajax' => TRUE,
        ));


      }
    }


    $output = theme('booking_calendar_admin', array(
      'week' => $week,
      'month' => $month,
      'year' => $year,
    ));
    $response = array(
      'output' => $output,
      'hours_table' => $hours_table,
    );

    return drupal_json_output($response);
  }
  return drupal_not_found();
}

/**
 * @file
 */

/**
 * @param $variables
 * @return string
 */
function theme_booking_calendar_admin_table_day_hours($variables) {
  //module_load_include('inc', 'booking_calendar', 'booking_calendar');
  $output = '';


  // For client table block variable.
  $widget = $variables['widget'];
  $ajax = $variables['ajax'];

  $hours = array();
  $minutes = 0;
  $interval = 30;

  if (isset($_SESSION['current_select'])) {
    $year = $_SESSION['current_select']['year'];
    $month = $_SESSION['current_select']['month'];
    $day = $_SESSION['current_select']['day'];
  }
  else {
    $year = date('Y');
    $month = date('n');
    $day = date('j');
  }


  if (empty($_SESSION['hours_settings'])) {
    $hours_settings = variable_get('booking_hours_settings', '');
  }
  else {
    $hours_settings = $_SESSION['hours_settings'];
  }


  if (empty($hours_settings)) {
    $hour_end = 22;
    $hour_begin = 8;
  }
  else {
    if (isset($hours_settings[$year]) && isset($hours_settings[$year][$month]) && isset($hours_settings[$year][$month][$day])) {
      $hour_end = $hours_settings[$year][$month][$day]['hour_end'];
      $hour_begin = $hours_settings[$year][$month][$day]['hour_begin'];
      if ($ajax) {
        $year = $variables['year'];
        $month = $variables['month'];
        $day = $variables['day'];
        $hour_end = $hours_settings[$year][$month][$day]['hour_end'];
        $hour_begin = $hours_settings[$year][$month][$day]['hour_begin'];
      }
    }
    else {
      $hour_end = 22;
      $hour_begin = 8;
    }
  }


  //count = (($hour_end - $hound_begin)*interval for hours)+2;
  $count = (($hour_end - $hour_begin) * 2) + 2;


  for ($i = 0; $i < $count; $i++) {
    $hours[$i] = date('H : i', mktime($hour_begin, $minutes, 0, date('n'), date('j'), date('Y')));
    $minutes += $interval;
  }


  if (!empty(variable_get('booking_calendar_names_courts', ''))) {
    $courts = variable_get('booking_calendar_names_courts', '');

    if (!empty($_SESSION['table_hours'])) {
      $year = $variables['year'];
      $month = $variables['month'];
      $day = $variables['day'];
      if ($widget) {
        $year = date('Y');
        $month = date('n');
        $day = date('j');
        if ($ajax) {
          $year = $variables['year'];
          $month = $variables['month'];
          $day = $variables['day'];
        }
      }
      if (isset($_SESSION['table_hours'][$year]) && isset($_SESSION['table_hours'][$year][$month]) && isset($_SESSION['table_hours'][$year][$month][$day])) {
        $courts = $_SESSION['table_hours'][$year][$month][$day];

      }
    }
  }
  else {
    $courts = _default_hours_and_name_courts();
  }


  //Add fist column - time.
  array_unshift($courts, array('name' => t('TIME - ') . $year . '-' . $month . '-' . $day));


  // Without admin form.
  if (!$widget) {
    // Add admin setting form for table hours.
    $court_form = drupal_get_form('booking_calendar_courts_form');
    $courts_form_html = render($court_form);
    $output .= $courts_form_html;
  }

  $classes = ' ';
  $output .= '<div id="booking-courts-wrapper"><table id="booking-courts"><thead><tr>';
  $k = 1;
  foreach ($courts as $court) {
    if ($k == 1) {
      $classes .= 'first';
    }
    else {
      $classes = '';
    }
    if (!empty($court['name'])) {
      $output .= '<td class="' . $classes . '">' . $court['name'] . '</td>';
    }
    else {
      $output .= '<td></td>';
    }
    $k++;
  }
  $output .= '</tr></thead>';


  foreach ($hours as $hour) {
    $output .= '<tr>';

    $a = 0;
    foreach ($courts as $court) {
      if ($a == 0) {
        $output .= '<td>' . $hour . '</td>';
      }
      else {
        if ($court['name']) {
          $hour_key = str_replace(' : ', '_', $hour);
          if (!empty(variable_get('booking_calendar_names_courts', ''))) {
            if (isset($court['hours'][$hour]['price'])) {
              $output .= '<td class="value" year="' . $year . '" month="' . $month . '" day="' . $day . '" hour="' . $hour . '" name="' . $court['name'] . ' ">' . $court['hours'][$hour]['price'] . '€' . '</td>';
            }
            else {
              $output .= '<td class="value" year="' . $year . '" month="' . $month . '" day="' . $day . '" hour="' . $hour . '" name="' . $court['name'] . ' ">' . 0 . '€' . '</td>';
            }

          }
          else {
            $output .= '<td class="value" year="' . $year . '" month="' . $month . '" day="' . $day . '" hour="' . $hour . '" name="' . $court['name'] . ' ">' . $court['hours'][$hour]['price'] . '</td>';
          }
        }
      }
      $a++;
    }
    '</tr>';
  }
  $output .= '</table></div>';

  return $output;
}


function theme_booking_calendar_cart_pre_output() {
  $output = '<div class="pre-cart-output"></div>';

  return $output;
}


/**
 *
 */
function theme_booking_calendar_admin($variables) {

  isset($variables['week']) ? $week = $variables['week'] : $week = _booking_calendar_calculate();;
  isset($variables['month']) ? $month = $variables['month'] : $month = date('n');
  isset($variables['year']) ? $year = $variables['year'] : $year = date('Y');

  $month_name = date('F', mktime(0, 0, 0, $month, date("j"), date('Y')));

  // Translate months.
  switch ($month_name) {
    case 'January' :
      $month_name = 'Sausis';
      break;
    case 'February' :
      $month_name = 'Vasaris';
      break;
    case 'March' :
      $month_name = 'Kovas';
      break;
    case 'April' :
      $month_name = 'Balandis';
      break;
    case 'May' :
      $month_name = 'Gegužė';
      break;
    case 'June' :
      $month_name = 'Birželis';
      break;
    case 'July' :
      $month_name = 'Liepa';
      break;
    case 'August' :
      $month_name = 'Rugpjūtis';
      break;
    case 'September' :
      $month_name = 'Rugsėjis';
      break;
    case 'October' :
      $month_name = 'Spalis';
      break;
    case 'November' :
      $month_name = 'Lapkritis';
      break;
    case 'December' :
      $month_name = 'Gruodis';
      break;
  }

  $widget = $variables['widget'];

  // 3. Print the contents of the array $ week
  // A calendar
  // Display the table.
  $output = '<div class="year">' . $year . '</div>
             <div id="controls">
                <div data-year="' . $year . '" data-month="' . $month . '" class="prev">' . t('Ankstesnis') . '</div><div class="month">' . $month_name . '</div><div  data-year="' . $year . '" data-month="' . $month . '" class="next">' . t('Kitas') . '</div></div>';
  $output .= '<table id="booking-calendar"><thead>';

  $output .= '<thead><tr>';
  $a = 1;
  for ($i = 6; $i < 13; $i++) {
    if ($widget) {
      $output .= '<td>' . _arabic_to_roman($a) . '</td>';
    }
    else {
      $output .= '<td>' . date('l', mktime(0, 0, 0, date('m'), $i, $year)) . '</td>';
    }
    $a++;
  }

  $output .= '</tr></thead>';
  for ($i = 0; $i < count($week); $i++) {
    $output .= "<tr>";
    for ($j = 0; $j < 7; $j++) {
      if (!empty($week[$i][$j])) {

        // If you are dealing with a Saturday and Sunday
        // highlights them.

        if ($j == 5 || $j == 6) {
          $classes = 'weekends';
          if ($week[$i][$j] == date('j')) {
            $classes = 'this weekends';
          }
        }
        elseif ($week[$i][$j] == date('j')) {
          $classes = 'this';
        }
        else {
          $classes = '';
        }
        if (isset($_SESSION['tables'])) {
          foreach ($_SESSION['tables'][$year][$month] as $key => $value) {
            if (!empty($_SESSION['tables'][$year][$month][$key])) {
              if ($j == $_SESSION['tables'][$year][$month][$key]['week_j'] && $i == $_SESSION['tables'][$year][$month][$key]['week_i']) {
                $classes = $_SESSION['tables'][$year][$month][$key]['chan'];
              }
            }
          }
        }
        else {
          $booking_table = variable_get('booking_calendar_book_table', '');
          if (!empty($booking_table)) {
            foreach ($booking_table[$year][$month] as $key => $value) {
              if (!empty($booking_table[$year][$month][$key])) {
                if ($j == $booking_table[$year][$month][$key]['week_j'] && $i == $booking_table[$year][$month][$key]['week_i']) {
                  $classes = $booking_table[$year][$month][$key]['chan'];
                }
              }
            }
          }
        }
        // Current box
        if (!empty($_SESSION['current_select'])) {
          if ($j == $_SESSION['current_select']['week_j'] && $i == $_SESSION['current_select']['week_i']
            && $year == $_SESSION['current_select']['year'] && $month == $_SESSION['current_select']['month']
          ) {
            $classes .= ' ' . 'select';
          }
        }


        $output .= '<td week_i="' . $i . '" week_j = "' . $j . '" class="' . $classes . '">' . $week[$i][$j] . '</td>';
      }
      else {
        $output .= "<td>&nbsp;</td>";
      }
    }
    $output .= "</tr>";
  }
  $output .= "</table>";

  return $output;
}


/**
 * @file
 */

function booking_calendar_courts_form($form, &$form_state) {


  if (!empty(variable_get('booking_calendar_names_courts', ''))) {
    $courts = variable_get('booking_calendar_names_courts', '');

    // Get data for current click state.
    if (!empty($_SESSION['current_select'])) {
      $current_state = $_SESSION['current_select'];
      $year = $current_state['year'];
      $month = $current_state['month'];
      $day = $current_state['day'];
      if (isset($_SESSION['table_hours'][$year]) && isset($_SESSION['table_hours'][$year][$month]) && isset($_SESSION['table_hours'][$year][$month][$day])) {
        $courts = $_SESSION['table_hours'][$year][$month][$day];
      }
    }
    else {
      $year = date('Y');
      $month = date('n');
      $day = date('j');
    }
  }
  else {
    $courts = _default_hours_and_name_courts();
    $year = date('Y');
    $month = date('n');
    $day = date('j');
  }


  $form['courts'] = array(
    '#type' => 'fieldset',
    '#title' => t('Courts settings for ') . '<strong>' . $year . '/' . $month . '/' . $day . '</strong>',
    '#weight' => 5,
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );

  $form['courts']['names'] = array(
    '#type' => 'fieldset',
    '#title' => t('Courts names'),
    '#weight' => 2,
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );


  $form['courts']['actions'] = array(
    '#type' => 'fieldset',
    '#title' => t('Courts actions'),
    '#weight' => 3,
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );

  $form['courts']['actions']['delete'] = array(
    '#type' => 'fieldset',
    '#title' => t('Courts delete'),
    '#weight' => 3,
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );

  $form['courts']['actions']['add'] = array(
    '#type' => 'fieldset',
    '#title' => t('Courts add'),
    '#weight' => 3,
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );

  if (isset($_SESSION['current_select'])) {
    $year = $_SESSION['current_select']['year'];
    $month = $_SESSION['current_select']['month'];
    $day = $_SESSION['current_select']['day'];
  }
  else {
    $year = date('Y');
    $month = date('n');
    $day = date('j');
  }


  if (empty($_SESSION['hours_settings'])) {
    $hours_settings = variable_get('booking_hours_settings', '');
  }
  else {
    $hours_settings = $_SESSION['hours_settings'];
  }


  if (empty($hours_settings)) {
    $hour_end = 22;
    $hour_begin = 8;
  }
  else {
    if (isset($hours_settings[$year]) && isset($hours_settings[$year][$month]) && isset($hours_settings[$year][$month][$day])) {
      $hour_end = $hours_settings[$year][$month][$day]['hour_end'];
      $hour_begin = $hours_settings[$year][$month][$day]['hour_begin'];
    }
    else {
      $hour_end = 22;
      $hour_begin = 8;
    }
  }

  $form['courts']['hour_begin'] = array(
    '#type' => 'textfield',
    '#title' => t('Hour begin'),
    '#default_value' => $hour_begin,
    '#size' => 60,
    '#maxlength' => 128,
  );
  $form['courts']['hour_end'] = array(
    '#type' => 'textfield',
    '#title' => t('Hour end'),
    '#default_value' => $hour_end,
    '#size' => 60,
    '#maxlength' => 128,
  );

  if (!empty(variable_get('booking_calendar_names_courts', ''))) {
    $flag = TRUE;
  }

  foreach ($courts as $court) {
    $form['courts']['names']['name']['name-' . $court['name']] = array(
      '#type' => 'textfield',
      '#title' => t('Name court'),
      '#default_value' => $court['name'],
      '#size' => 60,
      '#maxlength' => 128,
    );

    $form['courts']['prices']['price']['price-' . $court['name']] = array(
      '#type' => 'fieldset',
      '#title' => t('Courts prices') . ' ' . $court['name'],
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
    );


    if (isset($_SESSION['current_select'])) {
      $year = $_SESSION['current_select']['year'];
      $month = $_SESSION['current_select']['month'];
      $day = $_SESSION['current_select']['day'];
    }
    else {
      $year = date('Y');
      $month = date('n');
      $day = date('j');
    }

    $hours = array();
    $minutes = 0;
    $interval = 30;

    if (empty($_SESSION['hours_settings'])) {
      $hours_settings = variable_get('booking_hours_settings', '');
    }
    else {
      $hours_settings = $_SESSION['hours_settings'];
    }


    if (empty($hours_settings)) {
      $hour_end = 22;
      $hour_begin = 8;
    }
    else {
      if (isset($hours_settings[$year]) && isset($hours_settings[$year][$month]) && isset($hours_settings[$year][$month][$day])) {
        $hour_end = $hours_settings[$year][$month][$day]['hour_end'];
        $hour_begin = $hours_settings[$year][$month][$day]['hour_begin'];
      }
      else {
        $hour_end = 22;
        $hour_begin = 8;
      }
    }


    // Count = (($hour_end - $hound_begin)*interval for hours)+2.
    $count = (($hour_end - $hour_begin) * 2) + 2;

    for ($i = 0; $i < $count; $i++) {
      $hours[$i] = date('H : i', mktime($hour_begin, $minutes, 0, date('n'), date('j'), date('Y')));
      $minutes += $interval;
    }


    foreach ($hours as $hour) {
      $hour_key = str_replace(' : ', '_', $hour);

      if (isset($court['hours'][$hour]['price'])) {
        $default_value = $court['hours'][$hour]['price'];
      }
      else {
        $default_value = array();
      }


      $form['courts']['prices']['price']['price-' . $court['name']][$court['name'] . '_' . $hour_key] = array(
        '#type' => 'textfield',
        '#title' => t('Price court ') . $court['name'] . '  ' . $hour,
        '#default_value' => $default_value,
        '#size' => 60,
        '#maxlength' => 128,
      );

    }


    $form['courts']['actions']['delete'] = array(
      '#type' => 'submit',
      '#value' => t('Delete court'),
      '#attributes' => array('class' => array('delete-form')),
    );
    $form['courts']['actions']['add'] = array(
      '#type' => 'submit',
      '#value' => t('Add court'),
      '#attributes' => array('class' => array('add-form')),
    );
    $form['courts']['actions']['add_name_court'] = array(
      '#type' => 'textfield',
      '#title' => t('Name new court'),
      '#default_value' => 'U4',
      '#size' => 25,
      '#maxlength' => 32,
      '#attributes' => array('class' => array('add-form-name')),
    );
  }


  $form['submit_button'] = array(
    '#type' => 'submit',
    '#value' => t('Save cofiguration'),
    '#weight' => 10,
  );

  return $form;
}

function TrimArray($Input) {
  if (!is_array($Input)) {
    return trim($Input);
  }
  return array_map('TrimArray', $Input);
}

function booking_calendar_courts_form_submit($form, &$form_state) {

  // Clear input values!
  $form_state['values'] = TrimArray($form_state['values']);


  $hours = array();
  $minutes = 0;
  $interval = 30;


  if (!isset($form_state['values']['hour_begin']) || !isset($form_state['values']['hour_end'])) {
    $hour_begin = 8;
    $hour_end = 22;
  }
  else {
    $hour_begin = $form_state['values']['hour_begin'];
    $hour_end = $form_state['values']['hour_end'];
  }

  //count = (($hour_end - $hound_begin)*interval for hours)+2;
  $count = (($hour_end - $hour_begin) * 2) + 2;


  $hours_settings = array(
    'hour_begin' => $hour_begin,
    'hour_end' => $hour_end,
    'hour_count' => $count,
  );


  for ($i = 0; $i < $count; $i++) {
    $hours[$i] = date('H : i', mktime($hour_begin, $minutes, 0, date('n'), date('j'), date('Y')));
    $minutes += $interval;
  }


  $courts = array(
    1 => array(
      'name' => 'U1',
      'price' => 0,
    ),
    2 => array(
      'name' => 'U2',
      'price' => 0,
    ),
    3 => array(
      'name' => 'U3',
      'price' => 0,
    ),
    4 => array(
      'name' => 'U4',
      'price' => 0,
    ),
  );

  if (!empty(variable_get('booking_calendar_names_courts', ''))) {
    $courts = variable_get('booking_calendar_names_courts', '');
  }

  /***** Begin create courts final *****/

  $courts_final = array();
  foreach ($courts as $court) {
    foreach ($hours as $hour) {
      $hour_key = str_replace(' : ', '_', $hour);

      $hours_prices_new_court[$hour_key] = array(
        'hour' => $hour,
        'price' => 0,
      );
      if (isset($form_state['values'][$court['name'] . '_' . $hour_key])) {
        $hours_prices[$hour] = array(
          'hour' => $hour,
          'price' => $form_state['values'][$court['name'] . '_' . $hour_key],
        );
      }
      else {
        $hours_prices[$hour] = array(
          'hour' => $hour,
          'price' => 0,
        );
      }


      $courts_final[$court['name']] = array(
        'name' => $form_state['values']['name-' . $court['name']],
        'hours' => $hours_prices,
      );
    }
  }

  // ***** End create courts final *****


  /*** CREATE NEW COURT AND DELETE OLD COURT *****/

  if ($form_state['triggering_element']['#value'] == 'Add court') {
    $new_court[$form_state['values']['add_name_court']] = array(
      'name' => $form_state['values']['add_name_court'],
      'hours' => $hours_prices_new_court,
    );
    if (count($courts_final) < 5) {
      $courts_final = array_merge($courts_final, $new_court);
    }

  }

  if ($form_state['triggering_element']['#value'] == 'Delete court') {
    if (count($courts_final) > 1) {
      array_pop($courts_final);
    }
  }

  /********** END CREATE NEW COURT AND DELETE OLD COURT ************/


  if ($_SESSION['current_select']) {
    $year = $_SESSION['current_select']['year'];
    $month = $_SESSION['current_select']['month'];
    $day = $_SESSION['current_select']['day'];
  }
  else {
    $year = date('Y');
    $month = date('n');
    $day = date('j');
  }

  $_SESSION['hours_settings'][$year][$month][$day] = $hours_settings;

  variable_set('booking_hours_settings', $_SESSION['hours_settings']);
  variable_set('booking_calendar_names_courts', $courts_final);

  // Save for current click state.
  if (!empty($_SESSION['current_select'])) {
    $current_state = $_SESSION['current_select'];
    $year = $current_state['year'];
    $month = $current_state['month'];
    $day = $current_state['day'];
    $_SESSION['table_hours'][$year][$month][$day] = $courts_final;
  }


}


/**
 * @file
 */


/**
 * @return mixed
 * Calculate calendar arrays.
 */
function _booking_calendar_calculate() {

  // We calculate the number of days in the current month.
  $dayofmonth = date('t');
  // Counter for the days of the month.
  $day_count = 1;

  $month = date('n');

  $week = array();

  // 1. The first week.
  $num = 0;
  for ($i = 0; $i < 7; $i++) {
    // Calculate the number of days of the week for the number of.
    $dayofweek = date('w', mktime(0, 0, 0, $month, $day_count, date('Y')));

    // Leads to a number of the format 1 - Monday, ..., 6 - Saturday.
    $dayofweek = $dayofweek - 1;
    if ($dayofweek == -1) {
      $dayofweek = 6;
    }

    if ($dayofweek == $i) {
      // If the same days of the week,
      // Fill the array $week
      // Number of months.
      $week[$num][$i] = $day_count;
      $day_count++;
    }
    else {
      $week[$num][$i] = "";
    }
  }

  // 2. The following week of the month.
  while (TRUE) {
    $num++;
    for ($i = 0; $i < 7; $i++) {
      $week[$num][$i] = $day_count;
      $day_count++;
      // If you have reached the end of the month - leave
      // The loop.
      if ($day_count > $dayofmonth) {
        break;
      }
    }
    // If you have reached the end of the month - leave
    // From the cycle.
    if ($day_count > $dayofmonth) {
      break;
    }
  }
  return $week;
}

/**
 * @return array
 * Default values for table hours
 */
function _default_hours_and_name_courts() {

  $hours = array();

  $minutes = 0;
  $interval = 30;

  if (isset($_SESSION['current_select'])) {
    $year = $_SESSION['current_select']['year'];
    $month = $_SESSION['current_select']['month'];
    $day = $_SESSION['current_select']['day'];
  }
  else {
    $year = date('Y');
    $month = date('n');
    $day = date('j');
  }


  if (empty($_SESSION['hours_settings'])) {
    $hours_settings = variable_get('booking_hours_settings', '');
  }
  else {
    $hours_settings = $_SESSION['hours_settings'];
  }


  if (empty($hours_settings)) {
    $hour_end = 22;
    $hour_begin = 8;
  }
  else {
    $hour_end = $hours_settings[$year][$month][$day]['hour_end'];
    $hour_begin = $hours_settings[$year][$month][$day]['hour_begin'];
  }


  //count = (($hour_end - $hound_begin)*interval for hours)+2;
  $count = (($hour_end - $hour_begin) * 2) + 2;


  for ($i = 0; $i < $count; $i++) {
    $hours[$i] = date('H : i', mktime($hour_begin, $minutes, 0, date('n'), date('j'), date('Y')));
    $minutes += $interval;
  }

  // Define default values.
  $courts = array();

  $courts = array(
    1 => array(
      'name' => 'U1',
      'price' => 0,
    ),
    2 => array(
      'name' => 'U2',
      'price' => 0,
    ),
    3 => array(
      'name' => 'U3',
      'price' => 0,
    ),
    4 => array(
      'name' => 'U4',
      'price' => 0,
    ),
  );

  $courts_final = array();

  foreach ($courts as $court) {
    foreach ($hours as $hour) {
      $hours_prices[$hour] = array(
        'hour' => $hour,
        'price' => 0,
      );
      $courts_final[$court['name']] = array(
        'name' => $court['name'],
        'hours' => $hours_prices,
      );
    }
  }
  return $courts_final;
}


/**
 * @param $value
 * @return mixed
 * Custom function for create valid form-state keys for drupal form submit function.
 */
function _form_valid_keys($value) {
  return (str_replace(' : ', '_', $value));
}

/**
 * @param $value
 * @return string
 * Conver arabic number values to roman.
 */
function _arabic_to_roman($value) {
  if ($value < 0) {
    $value = -$value;
  }
  if (!$value) {
    return "0";
  }
  $thousands = (int) ($value / 1000);
  $value -= $thousands * 1000;
  $result = str_repeat("M", $thousands);
  $table = array(
    900 => "CM",
    500 => "D",
    400 => "CD",
    100 => "C",
    90 => "XC",
    50 => "L",
    40 => "XL",
    10 => "X",
    9 => "IX",
    5 => "V",
    4 => "IV",
    1 => "I"
  );
  while ($value) {
    foreach ($table as $part => $fragment) {
      if ($part <= $value) {
        break;
      }
    }
    $amount = (int) ($value / $part);
    $value -= $part * $amount;
    $result .= str_repeat($fragment, $amount);
  }
  return $result;
}


